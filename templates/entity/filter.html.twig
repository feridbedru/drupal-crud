{% block body %}
<?php

namespace Drupal\{{ entity.namespace }}\FilterForm;

use Drupal\Core\Database\Database;
use Drupal\Core\Form\FormBase;
use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Url;
use Drupal\Core\Link;
use Drupal\{{ entity.namespace }}\Controller\UtilityController;

class {{ entity.singularName | title | replace({' ': ''}) }}SearchForm extends FormBase
{

    /**
    * {@inheritdoc}
    */
    public function getFormId()
    {
        return '{{ entity.singularName|replace({' ': '_'}) |lower }}_search_form';
    }

    /**
    * {@inheritdoc}
    */
    public function buildForm(array $form, FormStateInterface $form_state)
    {
        $header_table = array(
            'id' => t('#'),
{% for field in fields %}
{% if field.isOnIndex == 1 %}
            '{{ field.name|replace({' ': '_'}) | lower  }}' => $this->t('{{ field.name | title  }}'), 
{% endif %}{% endfor %}
            [
                'data' => $this->t('Operations'),
                'colspan' => 4,
            ],
        );

        if (\Drupal::currentUser()->hasPermission('{{ entity.singularName|replace({' ': '_'}) |lower }} add')) {
            $form['link'] = [
                '#type' => 'link',
                '#title' => $this->t('Add New'),
                '#url' => Url::fromRoute('{{ entity.singularName|replace({' ': '_'}) |lower }}.add'),
                '#wrapper_attributes' => ['class' => 'col-md-6 col-xs-12'],
                '#attributes' => array('class' => array('button button--action button--primary')),
            ];
        }

        $form['filters'] = [
            '#type'  => 'container',
            '#open'  => true,
            '#attributes' => ['class' => 'row'],
        ];

{% for field in fields %}
{% if field.isOnFilter == 1 and field.type != 12 %}
        $form['filters']['{{ field.name|replace({' ': '_'}) | lower  }}'] = [
            '#type' => '{% if field.type == 1 %}textfield{% elseif field.type == 2 %}number{% elseif field.type == 3 %}url{% elseif field.type == 6 %}tel{% elseif field.type == 7 %}email{% elseif field.type == 8 %}number{% elseif field.type == 10 %}date{% elseif field.type == 11 %}checkbox{% elseif field.type == 13 %}datetime{% else %}textfield{% endif %}',
            '#title' => $this->t('{{ field.name | title  }}'),
            '#default_value' => (isset($data['{{ field.name|replace({' ': '_'}) | lower  }}'])) ? $data['{{ field.name|replace({' ': '_'}) | lower  }}'] : '',
            '#attributes' => array('class' => array('form-control')),
            '#prefix' => '<div class="form-group col-md-2">',
            '#suffix' => '</div>',
        ];

{% elseif field.isOnFilter == 1 and field.type == 12  %}
        ${{ field.relationEntity.pluralName|replace({' ': '_'}) |lower}} = array();
        $find_{{ field.relationEntity.pluralName|replace({' ': '_'}) | lower }} = \Drupal::database()->select('{{ field.relationEntity.pluralName|replace({' ': '_'}) | lower }}', '{{ field.relationEntity.pluralName|replace({' ': '_'}) | first | lower }}')
            ->fields('{{ field.relationEntity.pluralName|replace({' ': '_'}) | first | lower }}', ['id', '{{ field.relationField.name |replace({' ': '_'}) |lower}}']);
        ${{ field.relationEntity.pluralName|replace({' ': '_'}) |lower}}_data = $find_{{ field.relationEntity.pluralName|replace({' ': '_'}) | lower }}->execute()->fetchAll();
        foreach(${{ field.relationEntity.pluralName|replace({' ': '_'}) |lower}}_data as $value){
            ${{ field.relationEntity.pluralName|replace({' ': '_'}) |lower}}[$value->id] = $value->{{ field.relationField.name |replace({' ': '_'}) |lower}};
        }
        $form['filters']['{{ field.name|replace({' ': '_'}) | lower  }}'] = [
            '#type' => 'select',
            '#title' => $this
                ->t('{{ field.name | title  }}'),
            '#options' => ${{ field.relationEntity.pluralName|replace({' ': '_'}) |lower}},
            '#wrapper_attributes' => ['class' => 'col-md-6 col-xs-12'],
            '#attributes' => array('class' => array('form-control')),
            '#default_value' => (isset($data['{{ field.name|replace({' ': '_'}) | lower  }}'])) ? $data['{{ field.name|replace({' ': '_'}) | lower  }}'] : '',
            '#prefix' => '<div class="form-group col-md-2">',
            '#suffix' => '</div>',
        ];

{% endif %}
{% endfor %}

        $util = new UtilityController();
        $selectedLangCode = $util->getLanguage()['selectedLanguage'];
        $language_list = $util->getLanguage()['languageList'];

        $form['filters']['language'] = [
            '#type' => 'select',
            '#title' => $this->t('Language'),
            '#options' => $language_list,
            '#wrapper_attributes' => ['class' => 'col-md-2 col-xs-12'],
            '#attributes' => array('class' => array('form-control')),
            '#default_value' => $selectedLangCode,
            '#prefix' => '<div class="form-group col-md-2">',
            '#suffix' => '</div>',
        ];

        $form['filters']['actions'] = [
            '#type' => 'actions'
        ];

        $form['filters']['actions']['submit'] = [
            '#type' => 'submit',
            '#value' => t('Search'),
            '#wrapper_attributes' => ['class' => 'mb-3'],
            '#ajax' => [
                'callback' => [$this, 'findRows'],
                'wrapper' => 'list-container',
            ],
        ];

{% for field in fields %}
{% if field.isOnFilter == 1 %}
        ${{ field.name|replace({' ': '_'}) | lower  }} = "";
{% endif %}
{% endfor %}
        $language = "am";
        $resources = $this->getDataRows({% for field in fields %}{% if field.isOnFilter == 1 %}${{ field.name|replace({' ': '_'}) | lower  }}, {% endif %}{% endfor %}$language);

        // render table
        $form['table'] = [
            '#id' => 'list-container',
            '#type' => 'table',
            '#header' => $header_table,
            '#rows' =>  $resources,
            '#empty' => $this->t('No records found'),
            '#sticky' => TRUE,
        ];

        $form['pager'] = [
            '#type' => 'pager',
        ];

        $form['#attached']['library'][] = '{{ entity.namespace }}/bootstrap';

        return $form;
    }

    /**
     * {@inheritdoc}
     */
    public function validateForm(array &$form, FormStateInterface $form_state)
    {
    }

    /**
     * {@inheritdoc}
     */
    public function submitForm(array &$form, FormStateInterface $form_state)
    {
    }

    private function getDataRows({% for field in fields %}{% if field.isOnFilter == 1 %}${{ field.name|replace({' ': '_'}) | lower  }}, {% endif %}{% endfor %}$language)
    {
        $query = \Drupal::database()->select('{{ entity.pluralName|replace({' ': '_'}) | lower }}', '{{ entity.pluralName|replace({' ': '_'}) | first | lower }}')
            ->fields('{{ entity.pluralName|replace({' ': '_'}) | first | lower }}', ['id'{% for field in fields %}{% if field.isOnIndex == 1 or field.isOnFilter == 1 %}, '{{ field.name|replace({' ': '_'}) | lower }}'{% endif %}{% endfor %}, 'language'])
            ->extend('Drupal\Core\Database\Query\TableSortExtender')
            ->extend('Drupal\Core\Database\Query\PagerSelectExtender')
            ->limit(10);

{% for field in fields %}
{% if field.isOnFilter == 1 %}
        if (${{ field.name|replace({' ': '_'}) | lower  }} != "") {
{% if field.type == 1 %}
            $query->condition('{{ entity.pluralName|replace({' ': '_'}) | first | lower }}.{{ field.name|replace({' ': '_'}) | lower  }}', '%' . ${{ field.name|replace({' ': '_'}) | lower  }} . '%', 'like');
{% else %}
            $query->condition('{{ entity.pluralName|replace({' ': '_'}) | first | lower }}.{{ field.name|replace({' ': '_'}) | lower  }}',  ${{ field.name|replace({' ': '_'}) | lower  }},  '=');
{% endif %}
        }
{% endif %}
{% endfor %}
        if ($language != "") {
            $query->condition('{{ entity.pluralName|replace({' ': '_'}) | first | lower }}.language', $language, '=');
        }
        $query->orderBy('id', 'ASC');
        $results = $query->execute()->fetchAll();

        $rows = [];
        $count = 0;

        foreach ($results as $data) {
            if ($data->id != 0) {

                $count++;
                $linkDelete = '';
                $linkEdit = '';

                $url_view = Url::fromRoute('{{ entity.singularName|replace({' ': '_'}) |lower }}.show', ['id' => $data->id], []);
                $url_translate = Url::fromRoute('{{ entity.singularName|replace({' ': '_'}) |lower }}.translate', ['parent_id' => $data->id], []);
                if (\Drupal::currentUser()->hasPermission('{{ entity.singularName|replace({' ': '_'}) |lower }} delete')) {
                    $delete_options = array(
                        'attributes' => array(
                            'class' => array(
                                'button--danger',
                            ),
                        ),
                    );
                    $url_delete = Url::fromRoute('{{ entity.singularName|replace({' ': '_'}) |lower }}.delete', ['id' => $data->id], []);
                    $url_delete->setOptions($delete_options);
                    $linkDelete = Link::fromTextAndUrl('Delete', $url_delete);
                }

                if (\Drupal::currentUser()->hasPermission('{{ entity.singularName|replace({' ': '_'}) |lower }} edit')) {
                    $edit_options = array(
                        'attributes' => array(
                            'class' => array(
                                'button--secondary',
                            ),
                        ),
                    );
                    $url_edit = Url::fromRoute('{{ entity.singularName|replace({' ': '_'}) |lower }}.edit', ['id' => $data->id], []);
                    $linkEdit = Link::fromTextAndUrl('Edit', $url_edit);
                    $url_edit->setOptions($edit_options);
                }
            
                $con = Database::getConnection();
                $qry = $con->select('{{ entity.pluralName|replace({' ': '_'}) | lower }}', '{{ entity.pluralName|replace({' ': '_'}) | first | lower }}')
                    ->condition('id', $data->id)
                    ->fields('{{ entity.pluralName|replace({' ': '_'}) | first | lower }}');
                $dat = $qry->execute()->fetchAssoc();
                if ($cur_language_code != 'am'  && $data->language == 'am' &&  !$dat) {
                    $linkTranslate = Link::fromTextAndUrl('Translate', $url_translate);
                }

                $linkView = Link::fromTextAndUrl('View', $url_view);
{% for field in fields %}
{% if field.type == 12 %}
                ${{ field.relationEntity.singularName|replace({' ': '_'}) |lower}} = '';
                ${{ field.relationEntity.singularName|replace({' ': '_'}) |lower}}_id = $data->{{ field.name|replace({' ': '_'}) |lower}};
                if (${{ field.relationEntity.singularName|replace({' ': '_'}) |lower}}_id) {
                    $find_{{ field.relationEntity.singularName|replace({' ': '_'}) | lower }} = \Drupal::database()->select('{{ field.relationEntity.pluralName|replace({' ': '_'}) | lower }}', '{{ field.relationEntity.pluralName|replace({' ': '_'}) | first | lower }}')
                        ->condition('id', ${{ field.relationEntity.singularName|replace({' ': '_'}) |lower}}_id)
                        ->fields('{{ field.relationEntity.pluralName|replace({' ': '_'}) | first | lower }}');
                    ${{ field.relationEntity.singularName|replace({' ': '_'}) |lower}}_data = $find_{{ field.relationEntity.singularName|replace({' ': '_'}) | lower }}->execute()->fetchAll();
                    ${{ field.relationEntity.singularName|replace({' ': '_'}) |lower}} =  ${{ field.relationEntity.singularName|replace({' ': '_'}) |lower}}_data[0]->{{ field.relationField.name |replace({' ': '_'}) |lower}};
                }
{% endif %}
{% endfor %}
                $rows[$data->id] = array(
                    'id' => $count,
{% for field in fields %}{% if field.isOnIndex == 1 %}
                    '{{ field.name|replace({' ': '_'}) | lower  }}' => {% if field.type == 12 %}${{ field.relationEntity.singularName|replace({' ': '_'}) |lower}}{% else %}$data->{{ field.name|replace({' ': '_'}) | lower  }}{% endif %},
{% endif %}{% endfor %}
                    'view' => $linkView,
                    'translate' => ($cur_language_code != 'am'  && $data->language == 'am' &&  !$dat) ? $linkTranslate : "",
                    'edit' =>  $linkEdit,
                    'delete' => $linkDelete,
                );
            }
        }
        return $rows;
    }

    function findRows(array &$form, FormStateInterface $form_state)
    {
        $field = $form_state->getValues();
        $language = $field["language"];
        $rows = [];
        $rows = $this->getDataRows({% for field in fields %}{% if field.isOnFilter == 1 %}$field["{{ field.name|replace({' ': '_'}) | lower  }}"], {% endif %}{% endfor %} $language);
        $form['table']['#rows'] = $rows;

        return $form['table'];
    }
}
{% endblock %}